<!DOCTYPE html>

{% load static %}
{% load i18n %}
{% get_current_language as LANGUAGE_CODE %}
{% get_available_languages as LANGUAGES_CODE %}

<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!--<meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
  <link rel="icon" type="image/x-icon" href="{% static 'imgs/favicon.png' %}">
  <link rel="stylesheet" href="{% static 'css/introjs.css' %}">
  <!-- Intro OL CSS -->
  <link rel="stylesheet" href="{% static 'css/ol.css' %}" type="text/css">
  <!-- Custom Style Link -->
  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <!-- <link rel="stylesheet" href="./css/introjs-dark.css"> -->
  <!-- Bootstrap CDN -->
  <!--<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css"> -->
  <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}" type="text/css">
  <!-- FontAwesome CDN -->
  <link rel="stylesheet" href="{% static 'css/fontawesome.min.css' %}">
  <!-- Intro JS CDN -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intro.js/4.3.0/intro.min.js"> -->

  <!-- Box Icon CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/boxicons@latest/css/boxicons.min.css">
  <!-- Bootstrap Icon CDN -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
  <script src="{% static 'js/intro.min.js' %}"></script>
  <script src="{% static 'js/jquery-3.6.0.min.js' %}"></script>
  <script src="{% static 'js/functions.js' %}"></script>
  <!-- JQuery CDN 
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"
    integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script> -->

  {% csrf_token %}
  <title>Water Accounting App Dashboard</title>
</head>

<body>

  <div class="main_navbar">
    <div class="navbar_text">
      <h1>Karnataka Water Accounting Dashboard</h1>
    </div>
    <div class="logo_container">
      <img src="{% static 'imgs/World_Bank_Group_logo.png' %}" alt="logo">
    </div>
  </div>

  <div class="main_preloader" style="display: none;">
    <span class="main_loader"></span>
    <div class="loading_text">
      <p>Loading...Please wait!</p>
    </div>
  </div>


  <div class="main-content" id="body-pd">

    <!--Side Menu start-->
    <div class="l-navbar" id="nav-bar">
      <nav class="nav">
        <div>
          <!-- <a href="#" class="nav_logo">
            <i class='bx bx-globe nav_logo-icon'></i>
            <span class="nav_logo-name d-block text-break"
              style="width: 150px; margin-left: 0.5rem">WaterAccounting</span>
          </a> -->
          <div class="nav_list">
            <a class="nav_link" data-toggle="collapse" role="button" aria-expanded="false"
              aria-controls="collapseExample">
              <i class='bx bxs-layer nav_icon step-1'></i>
              <span class="nav_name">Base Layers</span>
            </a>
            <div class="submenu  collapse " id="collapseExample">
              <div class="logo-name">
                <h2>Base Layers</h2>
                <i class="bi bi-x closeBtn"></i>
              </div>
              <div class="subsecstart">
                <h4 class="heading">Base Layers</h4>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="baselayer" value="streetMap" checked="true"
                    id="flexRadioDefault1">
                  <label class="form-check-label" for="flexRadioDefault1">
                    Street Map
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="baselayer" value="otm" id="flexRadioDefault1">
                  <label class="form-check-label" for="flexRadioDefault1">
                    OpenTopoMap
                  </label>
                </div>

                <!-- <div class="form-check">
                  <input class="form-check-input" type="radio" name="baselayer" value="osm" id="flexRadioDefault1">
                  <label class="form-check-label" for="flexRadioDefault1">
                    OpenStreetMap
                  </label>
                </div> -->
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="baselayer" value="esa" id="flexRadioDefault1">
                  <label class="form-check-label" for="flexRadioDefault1">
                    ESA Worldcover 10m
                  </label>
                  <!-- <img src="{% static 'imgs/legend/worldcover_Legend.png' %}" id="esa-legend"
                    style="display: none; border:1px solid #e5e5e5"> -->
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="radio" name="baselayer" value="sen2" id="flexRadioDefault1">
                  <label class="form-check-label" for="flexRadioDefault1">
                    Sentinel-2 cloudless
                  </label>
                </div>
              </div>
              <div class="subsecstart">
                <h4 class="heading">Overlay Layers</h4>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="overlay" value="boundaries" id="checkDistricts">
                  <label class="form-check-label" for="boundaries">
                    Karnataka Districts
                  </label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" name="overlay" value="basins" id="checkbasins">
                  <label class="form-check-label" for="basins">
                    Karnataka Watersheds
                  </label>
                </div>

                <div class="form-check">
                  {% if user.is_authenticated %}
                  <input class="form-check-input" type="checkbox" name="overlay" value="myareas" id="checkareas">
                  <label class="form-check-label" for="myareas">
                    Your Added Areas
                  </label><br>
                  {% endif %}
                </div>
              </div>
            </div>
            <!-- LAYERS ENDS -->
            {% if user.is_authenticated %}
            <a class="nav_link " data-toggle="collapse" role="button" aria-expanded="false"
              aria-controls="collapseExample">
              <i class='bx bxs-map nav_icon step-4'></i>
              <span class="nav_name">Select Area</span>
            </a>
            <div class="submenu  collapse " id="collapseExample">
              <div class="logo-name">
                <h2>Add Area</h2>
                <i class="bi bi-x closeBtn"></i>
              </div>


              <div class="subsecstart" style="background-color: #e6e6e6; padding: 5px;">
                <h4 class="heading">Select District</h4>
                <div class="input-group">
                  <select class="form-select" id="selectDistrict" aria-label="Example select with button addon">
                    <option value="noarea" id="noarea">Select District</option>
                  </select>
                </div>
              </div>
              <p>Or</p>

              <div style="background-color: #e6e6e6; padding: 5px;">
                <h4 class="heading">Select Watershed</h4>
                <div class="input-group">
                  <select class="form-select" id="selectWatershed" aria-label="Example select with button addon">
                    <option value="noarea" id="noarea">Select Watershed</option>
                  </select>
                </div>
              </div>

              

              <hr />
              <div class="logo-name">
                <h2>Select Added Area</h2>
              </div>


              <div style="background-color: #e6e6e6; padding: 5px;">
                <h4 class="heading">Select your added areas</h4>
                <div class="input-group">

                  <select class="form-select" id="areaSelect" aria-label="Example select with button addon">
                    <option value="noarea" id="noarea">Choose...</option>
                  </select>
                </div>
              </div>


            </div>


            <!-- EXISTING AREAS ENDS -->

            <a class="nav_link " data-toggle="collapse" role="button" aria-expanded="false"
              aria-controls="collapseExample">
              <i class='bx bxs-parking nav_icon step-6'></i>
              <span class="nav_name" style="width: 150px; line-height: 24px;">Data
                Products</span>
            </a>
            <div class="submenu  collapse " id="collapseExample">
              <div class="logo-name">
                <h2>Data Products</h2>
                <i class="bi bi-x closeBtn"></i>
              </div>


              <div class="subsecstart">
                <h4 class="heading">Precipitation</h4>
                <div class="input-group">
                  <select class="form-select" name="precip" id="precip" aria-label="Example select with button addon">
                    <option value="chirps" selected>Chirps</option>
                    <option value="gpm">GPM</option>
                    <!-- <option value="persiann">Persiann</option> -->
                    <option value="gsmap">GsMAP</option>
                    <option value="era5">ERA5</option>
                    <option value="imd">IMD</option>
                    <option value="ensind">Ensemble</option>
                  </select>
                </div>
                <div class="subsecstart">
                  <h4 class="heading">Evapotranspiration</h4>
                  <div class="input-group">
                    <select class="form-select" name="et" id="et" aria-label="Example select with button addon">
                      <option value="nrsc" selected>NRSC ET</option>
                      <option value="wapor3">WaPOR3</option>
                      <option value="ssebop" >SSebop</option>
                      <!-- <option value="wapor2">WaPOR2</option> -->
                     
                      <!-- <option value="enset">Ensemble Africa</option> -->
                      <option value="ensetglobal">Ensemble Global</option>
                    </select>
                  </div>
                </div>

              </div>
            </div>

            <a class="nav_link  " data-toggle="collapse" role="button" aria-expanded="false"
              aria-controls="collapseExample">
              <i class='bx bxs-time nav_icon step-5'></i>
              <span class="nav_name">Time Range</span>
            </a>
            <div class="submenu  collapse" id="collapseExample">
              <div class="logo-name">
                <h2>Time Range</h2>
                <i class="bi bi-x closeBtn"></i>
              </div>

              <div class="subsecstart">
                <h4 class="heading">Start Year</h4>
                <div class="input-group">
                  <select class="form-select" name="startdate" id="startdate"></select>
                </div>
                <div class="subsecstart">
                  <h4 class="heading">End Year</h4>
                  <div class="input-group">
                    <select class="form-select" name="enddate" id="enddate"></select>
                  </div>
                </div>

              </div>
              <button class="btn btn-primary-rep" onclick="getReport()"
                style="background-color:#0082E4; color: #fff; margin-top:1rem; width: 100%;">Get
                Report</button>

            </div>
            <!-- TIME RANGE ENDS -->


            <!-- PREVIOUS REPORTS ENDS -->
            <a class="nav_link" data-toggle="collapse" role="button" aria-expanded="false"
              aria-controls="collapseExample">
              <i class='bx bxs-report nav_icon step-7'></i>
              <span class="nav_name">Previous Reports</span>
            </a>
            <div class="submenu  collapse " id="collapseExample">
              <div class="logo-name">
                <h2>Previous Reports</h2>
                <i class="bi bi-x closeBtn"></i>
              </div>



              <div class="subsecstart">
                <div class="input-group mb-3">
                  <input type="text" class="form-control" id="reportSearch" onkeyup="searchReport()"
                    placeholder="Search report...">
                </div>

                <!-- <h5>Previous Reports</h5> -->
                <div style="overflow-y: auto; height:50vh; " class="w-100" id="previoustasks">
                </div>
                <button type="button" class="btn btn-light mt-3" onclick="getTasks()"
                  style="background-color:#212529;  color: #ffffff; text-align: center; font-weight: 500; padding: 0.7rem; display: flex; align-items: center;">Refresh
                  <i class='bx bx-refresh'
                    style="font-size: 24px; text-align: center; margin-left: 0.5rem;"></i></button>
              </div>
            </div>
            {% endif %}
            <!-- PREVIOUS REPORTS ENDS -->
          </div>
        </div>
      </nav>
    </div>
    <!--Side Menu end-->

    <!-- Menu Icon & Right Icons -->
    <div class="wb-button-container print-none">
      <!-- <header class="header" id="header">
        <div class="header_toggle"> <i class='bx bx-menu' id="header-toggle"></i> </div>
      </header> -->


      <div class="toogleBtn">
        {% if user.is_authenticated %}

        <form action="{% url 'logout' %}" method="post">
          {% csrf_token %}

          <button style="padding: 0px; border: none;" class="wb-button " type="submit" title="logout"
            onclick="javascript:introJs().start()">
            <i class="fas fa-sign-out-alt step-9"></i>
          </button>
        </form>

        <div class="wb-button " title="info" data-bs-toggle="modal" data-bs-target="#about-us-modal">
          <i class="fas fa-info-circle step-8"></i>
        </div>
        {% else %}
        <a href="{% url 'login' %}">
          <div class="wb-button " title="login" data-bs-toggle="modal">
            <i class="fas fa-sign-in-alt"></i>
          </div>
        </a>
        {% endif %}
        {% if user.is_authenticated %}
        <!-- <div class="wb-button" data-bs-toggle="modal" data-bs-target="#addLayer" title="Add new area from vector layer"
          id="addlayerbtn">
          <i class="fas fa-layer-group step-2"></i>
        </div> -->
        <div class="wb-button" title="Draw a new area" data-bs-toggle="button" autocomplete="off" id="addarea">
          <i class="fas fa-map-marked step-3"></i>
        </div>
        {% endif %}
      </div>
    </div>
    <!-- Menu Icon & Right Icons -->

    <!-- More Features -->
    <div class="toogleBtn moreFeatures">
      <div class="boxes" id="featuresBox">
        <div class="moreIcons">
          <button type="button" class="btn btn-primary fas fa-ruler d-flex justify-content-center"
            title="Distance Measurement" data-bs-toggle="button" id="distance_measurement" geomType="LineString">
          </button>
          <button type="button" class="btn btn-primary fas fa-draw-polygon d-flex justify-content-center"
            title="Area Measurement" data-bs-toggle="button" id="area_measurement" geomType="Polygon">
          </button>
          <button type="button" class="btn btn-primary fas fa-expand-arrows-alt d-flex justify-content-center"
            title="Full Extent" id="full_extent">
          </button>
          <button type="button" class="btn btn-primary fas fa-eraser d-flex justify-content-center" title="Clear"
            id="clear">
          </button>
        </div>

      </div>
    </div>

    <!-- Zoom In & Zoom Out Button -->
    <!-- <div class="ol-zoom ol-unselectable ol-control" id="zoomBox" style="pointer-events: auto;">
            <button class="ol-zoom-in" type="button" title="Zoom in">+</button>
            <button class="ol-zoom-out" type="button" title="Zoom out">−</button>
        </div> -->




    <div class="modal fade" id="deleteReport-modal" tabindex="-1" role="dialog" aria-labelledby="deleteReportLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteReportLabel">Confirm Deletion</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to delete this report?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
          </div>
        </div>
      </div>
    </div>



    <!-- Add New Area Modal -->
    <!-- <div class="modal fade" id="addLayer" tabindex="-1" role="dialog" aria-labelledby="addModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addModalLabel">Add new area</h5>
          </div>
          <div class="modal-body">
            <label class="form-label" for="customFile">Upload vector layer (KML/Geojson)</label>
            <input type="file" class="form-control" id="customFile" onchange="readFile(this)" /><br>
            <label class="form-label" for="customName">Column name of the area feature</label>
            <input type="text" class="form-control" id="customName" placeholder="Column Name" />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary close" data-bs-dismiss="modal"
              aria-label="Close">Close</button>
            <button type="submit" class="btn btn-primary" onclick="addLayer()">Load data</button>
          </div>
        </div>
      </div>
    </div> -->

    <!-- Add Digitizing Modal -->
    <div class="modal fade" id="drawModal" tabindex="-1" role="dialog" aria-labelledby="drawModalLabel"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="drawModalLabel">Digitized feature</h5>
          </div>
          <div class="modal-body">
            <label class="form-label" for="featName">Feature's name</label>
            <input type="text" class="form-control" id="featName" />
            <input type="hidden" class="form-control" id="featGeom" />
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary close" data-bs-dismiss="modal"
              aria-label="Close">Close</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" aria-label="Cancel">Cancel
              feature</button>
            <button type="submit" class="btn btn-primary" aria-label="Add" onclick="addFeatures()">Add feature</button>
          </div>
        </div>
      </div>
    </div>

    <!--  Default Get Report Modal -->
    <div class="modal fade" id="returnModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
      aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="exampleModalLongTitle">India Water Accounting Dashboard</h5>
            <button type="button" class="btn btn-light close" data-bs-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body py-3">
            <div id="returnText"></div>
          </div>
        </div>
      </div>
    </div>

    <!--Map Image Starts-->
    <div id="map" style="margin-top: 60px;">


    </div>

    <div class="legend_img_container">
      <img src="{% static 'imgs/legend/worldcover_Legend.png' %}" id="esa-legend"
        style="display: none; border:1px solid #e5e5e5">
    </div>

    <!-- Counts -->
    <div class="coordinates">
      <span id="x">X: 0</span>,&nbsp;
      <span id="y">Y: 0</span>
    </div>

    <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content"></div>
    </div>

  </div>


  <!-- Modal-2 -->


  <!-- Footer -->

  <footer class="page-footer font-small">
    <div class="footer-copyright text-center py-2">Karnataka Water Accounting Dashboard © 2024
    </div>
  </footer>


  <!-- Footer -->
  <script src="{% static 'js/mobile-detect.min.js' %}"></script>
  <script src="{% static 'js/bootstrap.bundle.5.0.beta3.min.js' %}"></script>
  <script src="{% static 'js/ol.js' %}" type="text/javascript"></script>
  <script src="{% static 'js/proj4.js' %}" type="text/javascript"></script>
  <script src="{% static 'js/intro.js' %}"></script>
  <script src="{% static 'js/turf.min.js' %}"></script>
  <script src="{% static 'js/index.js' %}"></script>
  <!-- App code -->
  <script>
    var epsgsrc = 'EPSG:3857'
    var espgdest = 'EPSG:4326'
    var epsgmoll = 'ESRI:53009'
    proj4.defs(
      'ESRI:53009',
      '+proj=moll +lon_0=0 +x_0=0 +y_0=0 +a=6371000 ' +
      '+b=6371000 +units=m +no_defs'
    );
    var mainBondingBox = turf.polygon([[[-180, -70], [-180, 70], [180, 70], [180, -70], [-180, -70]]], { name: 'main bounding box' })
    ol.proj.proj4.register(proj4);
    var csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    var file;
    var addid;


    function searchReport() {
      var input, filter, reportsContainer, reports, report, i, txtValue;
      input = document.getElementById("reportSearch");
      filter = input.value.toUpperCase();
      reportsContainer = document.getElementById("previoustasks");
      reports = reportsContainer.getElementsByTagName("div");

      for (i = 0; i < reports.length; i++) {
        report = reports[i];
        txtValue = report.textContent || report.innerText;
        if (txtValue.toUpperCase().indexOf(filter) > -1) {
          reports[i].style.display = "";
        } else {
          reports[i].style.display = "none";
        }
      }
    }


    //$('.input-daterange').datepicker({
    //          format: 'yyyy-mm'
    //        });
    var container = document.getElementById('popup');
    var content = document.getElementById('popup-content');
    var closer = document.getElementById('popup-closer');

    var hovered = null;
    var newfeat = null;

    function sleep(milliseconds) {
      var timeStart = new Date().getTime();
      while (true) {
        var elapsedTime = new Date().getTime() - timeStart;
        if (elapsedTime > milliseconds) {
          break;
        }
      }
    }
    var overlay = new ol.Overlay({
      element: container,
      autoPan: true,
      autoPanAnimation: {
        duration: 250,
      },
    });

    closer.onclick = function () {
      overlay.setPosition(undefined);
      closer.blur();
      bobasource.clear()
      return false;
    };
    var drawModal = new bootstrap.Modal(document.getElementById('drawModal'), {
      keyboard: false
    })

    var attribution = new ol.control.Attribution({
      collapsible: false,
    });

    var otmlayer = new ol.layer.Tile({
      source: new ol.source.OSM({
        url: 'https://{a-c}.tile.opentopomap.org/{z}/{x}/{y}.png'
      })
    })

    var streetMaplayer = new ol.layer.Tile({
      source: new ol.source.OSM({
        url: 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}',
        attribution: "Tiles &copy; Esri"
      })
    })


    var osmlayer = new ol.layer.Tile({
      source: new ol.source.OSM()
    })




    var basinFeatures;
    var districtFeatures;
    var IntersectionDataFeatures;
    var selectedIntersectionBasin;

    $(document).ready(function () {
      $.getJSON('/static/data/karnataka_watershed.geojson', function (data) {
        basinFeatures = data.features;
        basinFeatures.sort(function (a, b) {
          return a.properties.Watersheds.localeCompare(b.properties.Watersheds);
        });
        basinFeatures.forEach(function (feature) {
          $('#selectWatershed').append('<option value="' + feature.properties.Watersheds + '">' + feature.properties.Watersheds + '</option>');
        });
      });

      $.getJSON('/static/data/karnataka_districts.geojson', function (data) {
        districtFeatures = data.features;
        districtFeatures.sort(function (a, b) {
          return a.properties.District.localeCompare(b.properties.District);
        });
        districtFeatures.forEach(function (feature) {
          $('#selectDistrict').append('<option value="' + feature.properties.District + '">' + feature.properties.District + '</option>');
        });
      });


      $('#selectWatershed').change(function () {
        var selectedBasin = $(this).val();

        if (selectedBasin !== 'noarea') {
          var selectedFeature = basinFeatures.find(feature => feature.properties.Watersheds === selectedBasin);
          if (selectedFeature) {
            polysource.clear(); // Remove all previous features
            var geom = selectedFeature.geometry;
            var olGeom;
            if (geom.type === 'Polygon') {
              olGeom = new ol.geom.Polygon(geom.coordinates);
            } else if (geom.type === 'MultiPolygon') {
              olGeom = new ol.geom.MultiPolygon(geom.coordinates);
            }
            if (olGeom) {
              newfeat = new ol.Feature({
                geometry: olGeom.transform(espgdest, epsgsrc),
                name: selectedBasin
              });
              polysource.addFeature(newfeat);
              var ext = newfeat.getGeometry().getExtent();
              if (!ol.extent.isEmpty(ext)) {
                map.getView().fit(ext, map.getSize());
              } else {
                console.log('Empty extent for selected basin:', selectedBasin);
              }
              checkDataConstraint();
            }
          }
          $('#selectDistrict').val('noarea');
          $('#areaSelect').val('noarea');

        } else {
          polysource.clear();
        }
      });


      $('#selectDistrict').change(function () {
        var selectedDistrict = $(this).val();
        if (selectedDistrict !== 'noarea') {
          var selectedFeature = districtFeatures.find(feature => feature.properties.District === selectedDistrict);
          if (selectedFeature) {
            polysource.clear(); // Remove all previous features
            var geom = selectedFeature.geometry;
            var olGeom;
            if (geom.type === 'Polygon') {
              olGeom = new ol.geom.Polygon(geom.coordinates);
            } else if (geom.type === 'MultiPolygon') {
              olGeom = new ol.geom.MultiPolygon(geom.coordinates);
            }
            if (olGeom) {
              newfeat = new ol.Feature({
                geometry: olGeom.transform(espgdest, epsgsrc),
                name: selectedDistrict
              });
              polysource.addFeature(newfeat);
              var ext = newfeat.getGeometry().getExtent();
              if (!ol.extent.isEmpty(ext)) {
                map.getView().fit(ext, map.getSize());
              } else {
                console.log('Empty extent for selected district:', selectedDistrict);
              }
              checkDataConstraint();
            }
          }
          $('#selectWatershed').val('noarea');
          $('#areaSelect').val('noarea');

        } else {
          polysource.clear();
        }
      });

    })






    /*var sentinellayer = new ol.layer.Image({
      source: new ol.source.ImageWMS({*/

    var sentinellayer = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'https://tiles.maps.eox.at/wms?',
        params: { 'LAYERS': 's2cloudless_3857' },
        version: '1.1.1',
        format: 'image/png',
        ratio: 1,
        serverType: 'mapserver',
        attributions: ['Sentinel-2 cloudless - <a href="https://s2maps.eu" target="_blank" title="Sentinel-2 cloudless">https://s2maps.eu</a> by <a href="https://eox.at/" target="_blank" title="Eox Company">EOX IT Services GmbH</a> (Contains modified Copernicus Sentinel data 2016 & 2017)']
      }),
      visible: false
    })

    var worldcover = new ol.layer.Tile({
      source: new ol.source.TileWMS({
        url: 'https://services.terrascope.be/wms/v2?',
        params: { 'LAYERS': 'WORLDCOVER_2020_MAP', "TILED": "true", "VERSION": "1.1.1" },
        version: '1.1.1',
        format: 'image/png',
        attributions: ['ESA Worldcover 10m <a href="https://esa-worldcover.org/" target="_blank" title="ESA Worldcover 10m">https://esa-worldcover.org/</a>']
      }),
      visible: false
    })




    var CountryBoundaryStyle = new ol.style.Style({
      stroke: new ol.style.Stroke({
        color: 'black',
        width: 2
      })
    });

    var CountryBoundarySource = new ol.source.Vector({
      url: '/static/data/karnataka_boundary.geojson',
      format: new ol.format.GeoJSON()
    });

    var boundaryLayer = new ol.layer.Vector({
      source: CountryBoundarySource,
      style: CountryBoundaryStyle,
      name: 'boundary'
    });




    var polystyle = new ol.style.Style({
      fill: new ol.style.Fill({
        color: 'rgba(255, 0, 0, 0.4)',
      }),
      stroke: new ol.style.Stroke({
        color: '#ff0000',
        width: 2,
      }),
      image: new ol.style.Circle({
        radius: 7,
        fill: new ol.style.Fill({
          color: '#ffcc33',
        }),
      }),
    })

    var polysource = new ol.source.Vector();
    var polyvector = new ol.layer.Vector({
      source: polysource,
      style: polystyle,
      name: 'selected,'
    });

    //Layer for storing measurement vectors
    var measurevector = new ol.layer.Vector({
      source: new ol.source.Vector(),
      name: 'measure'
    });

    var bobastyle = new ol.style.Style({
      fill: new ol.style.Fill({
        color: 'rgba(102, 51, 153, 0.4)',
      }),
      stroke: new ol.style.Stroke({
        color: '#663399',
        width: 2,
      }),
      image: new ol.style.Circle({
        radius: 7,
        fill: new ol.style.Fill({
          color: '#ffcc33',
        }),
      })
    })

    var bobasource = new ol.source.Vector();
    var bobavector = new ol.layer.Vector({
      source: bobasource,
      style: bobastyle,
      name: 'selected,'
    });

    var areastyle = new ol.style.Style({
      fill: new ol.style.Fill({
        color: 'rgba(255, 255, 0, 0.4)',
      }),
      stroke: new ol.style.Stroke({
        color: '#ffff00',
        width: 2,
      }),
      image: new ol.style.Circle({
        radius: 7,
        fill: new ol.style.Fill({
          color: '#ffcc33',
        }),
      })
    })

    var areahighlight = new ol.style.Style({
      fill: new ol.style.Fill({
        color: 'rgba(0, 255, 0, 0.4)',
      }),
      stroke: new ol.style.Stroke({
        color: '#00ff00',
        width: 3,
      }),
      image: new ol.style.Circle({
        radius: 7,
        fill: new ol.style.Fill({
          color: '#ffcc33',
        }),
      }),
      text: new ol.style.Text({
        font: '12px Calibri,sans-serif',
        fill: new ol.style.Fill({
          color: '#000',
        }),
        stroke: new ol.style.Stroke({
          color: '#fff',
          width: 3,
        }),
      }),
    })

    var areasource = new ol.source.Vector();
    var areavector = new ol.layer.Vector({
      source: areasource,
      style: areastyle,
      name: 'areas',
    });
    areavector.setVisible(false);


    var basinstyle = new ol.style.Style({
      fill: new ol.style.Fill({
        color: 'rgba(100, 100, 100, 0.2)',
      }),
      stroke: new ol.style.Stroke({
        color: '#000000',
        width: 2,
      }),
      text: new ol.style.Text({
        font: '12px Calibri,sans-serif',
        fill: new ol.style.Fill({
          color: '#000',
        }),
        stroke: new ol.style.Stroke({
          color: '#fff',
          width: 3,
        }),
      }),
    })


    var basinhighlight = new ol.style.Style({
      fill: new ol.style.Fill({
        color: 'rgba(0, 115, 207, 0.4)',
      }),
      stroke: new ol.style.Stroke({
        color: '#0073cf',
        width: 3,
      }),
      text: new ol.style.Text({
        font: '12px Calibri,sans-serif',
        fill: new ol.style.Fill({
          color: '#000',
        }),
        stroke: new ol.style.Stroke({
          color: '#fff',
          width: 3,
        }),
      }),
    })
    var geoJSONFormat = new ol.format.GeoJSON({});
    var wapor_source = [];
    var basinvector = new ol.layer.Vector({
      source: new ol.source.Vector({
        format: geoJSONFormat,
        url: '/static/data/karnataka_watershed.geojson'
      }),
      name: 'basins',
      style: basinstyle
    });
    basinvector.setVisible(false);

    var DistrictsStyle = new ol.style.Style({
      fill: new ol.style.Fill({
        color: 'rgba(100, 100, 100, 0.2)',
      }),
      stroke: new ol.style.Stroke({
        color: '#000000',
        width: 2,
      }),
      text: new ol.style.Text({
        font: '12px Calibri,sans-serif',
        fill: new ol.style.Fill({
          color: '#000',
        }),
        stroke: new ol.style.Stroke({
          color: '#fff',
          width: 3,
        }),
      }),
    })
    var boundhighlight = new ol.style.Style({
      fill: new ol.style.Fill({
        color: 'rgba(100, 100, 100, 0.4)',
      }),
      stroke: new ol.style.Stroke({
        color: '#000000',
        width: 3,
      }),
    })

    var boundsvector = new ol.layer.Vector({
      source: new ol.source.Vector({
        format: geoJSONFormat,
        url: '/static/data/karnataka_districts.geojson'
      }),
      name: 'bounds',
      style: DistrictsStyle
    });
    boundsvector.setVisible(false);

    var map = new ol.Map({
      controls: ol.control.defaults().extend(
        [
          new ol.control.ScaleLine({
            bar: false,
            steps: 4,
            text: true,
            minWidth: 100
          })
        ]),
      target: 'map',
      layers: [otmlayer, osmlayer, worldcover, streetMaplayer, sentinellayer, boundaryLayer, areavector, polyvector, basinvector, boundsvector, bobavector, measurevector],
      view: new ol.View({
        center: ol.proj.fromLonLat([75, 15]),
        minZoom: 4,
        zoom: 7,
        extent: ol.proj.transformExtent([68,10, 84,19], 'EPSG:4326', 'EPSG:3857')

      }),
      overlays: [overlay]
      //controls: ol.control.defaults({attribution: false}).extend([attribution])
    });
    //Create overlay for measurement
    function createMeasureOverlay() {
      return new ol.Overlay({
        element: document.getElementById("measure_popup"),
        offset: [0, -15],
        positioning: 'bottom-center',
        className: 'ol-tooltip-measure ol-tooltip .ol-tooltip-static'
      });
    }

    //Meaure Area and Distance
    var measuredraw, measureOverlayArrays = [];

    function calArea(measure_overlay, overlayPosition, area) {
      var measure_label;
      measure_overlay.setPosition(overlayPosition);
      if (area > 10000) {
        measure_label = Math.round((area / 1000000) * 100) / 100 + ' KM\xB2';
      } else {
        measure_label = Math.round(area * 100) / 100 + ' M\xB2';
      }
      measure_overlay.element.innerHTML = '<b>' + measure_label + '</b>';
    }

    function calDistance(measure_overlay, overlayPosition, length) {
      var measure_label;
      if (parseInt(length) == 0) {
        measure_overlay.setPosition([0, 0]);
      }
      else {
        measure_overlay.setPosition(overlayPosition);
        if (length > 100) {
          measure_label = Math.round((length / 1000) * 100) / 100 + ' KM';
        } else {
          measure_label = Math.round(length * 100) / 100 + ' M';
        }
        measure_overlay.element.innerHTML = '<b>' + measure_label + '</b>';
      }
    }

    function addMeasureInteractions(geomType) {
      if (measuredraw) {
        map.removeInteraction(measuredraw);
      }
      measuredraw = new ol.interaction.Draw({
        source: measurevector.getSource(),
        type: geomType,
      });
      measuredraw.on('drawstart', function (event) {
        var that = this;
        var measure_overlay = createMeasureOverlay()
        that.coordinates_length = 0;
        measureOverlayArrays.push(measure_overlay);
        measure_overlay.setPosition([0, 0]);
        measure_overlay.element.style.display = 'block';
        map.addOverlay(measure_overlay);

        event.feature.getGeometry().on('change', function (e) {
          if (e.target.getType() == "Polygon") {
            var geom = e.target.clone();
            area = geom.transform(epsgsrc, epsgmoll).getArea();
            calArea(measure_overlay, e.target.getInteriorPoint().getCoordinates().slice(0, 2), area);
          } else {
            var coordinates = e.target.getCoordinates();
            if (coordinates.length > that.coordinates_length) {
              that.coordinates_length = coordinates.length;
              partOverLay = createMeasureOverlay();
              map.addOverlay(partOverLay);
              measureOverlayArrays.push(partOverLay);
            }
            else {
              that.coordinates_length = coordinates.length;
            }

            var partLine = new ol.geom.LineString([coordinates[that.coordinates_length - 2], coordinates[that.coordinates_length - 1]]);
            var p1 = partLine.getCoordinates()[0];
            var p2 = partLine.getCoordinates()[1];
            var midPoint = [(p1[0] + p2[0]) / 2, (p1[1] + p2[1]) / 2];

            var partGeom = partLine.clone();
            calDistance(partOverLay, midPoint, partGeom.transform(epsgsrc, epsgmoll).getLength());

            if (that.coordinates_length > 2 && e.target.getLength() > new ol.geom.LineString([coordinates[0], coordinates[1]]).getLength()) {
              var geom = e.target.clone();
              length = geom.transform(epsgsrc, epsgmoll).getLength();
              calDistance(measure_overlay, e.target.getLastCoordinate(), length);
            }
          }
        });
      });
      map.addInteraction(measuredraw);
    }

    //Handles Distance Measurement
    $("#distance_measurement").click(function (e) {
      $("#area_measurement").removeClass('active');
      if ($(this).hasClass('active')) {
        var geomType = e.target.getAttribute('geomType');
        addMeasureInteractions(geomType);
      } else {
        map.removeInteraction(measuredraw);
        // for(var i = 0; i < measureOverlayArrays.length; i++) {
        //   map.removeOverlay(measureOverlayArrays[i]);
        // }
        // measureOverlayArrays = [];
        // measurevector.getSource().clear();
      }
    });

    //Handles Area Measurement
    $("#area_measurement").click(function (e) {
      $("#distance_measurement").removeClass('active');
      if ($(this).hasClass('active')) {
        var geomType = e.target.getAttribute('geomType');
        addMeasureInteractions(geomType);
      } else {
        map.removeInteraction(measuredraw);
        // for(var i = 0; i < measureOverlayArrays.length; i++) {
        //   map.removeOverlay(measureOverlayArrays[i]);
        // }
        // measureOverlayArrays = [];
        // measurevector.getSource().clear();
      }
    });

    // Switch to full extent
    $("#full_extent").click(function () {
      map.setView(
        new ol.View({
          center: ol.proj.fromLonLat([78, 24]),
          zoom: 5
        })
      )
    });

    // Clear measure interaction, measure features and measure overlays
    $("#clear").click(function () {
      $("#area_measurement").removeClass('active');
      $("#distance_measurement").removeClass('active');
      if (measuredraw) {
        map.removeInteraction(measuredraw);
      }
      if (draw) {
        // map.removeInteraction(draw);
        event.target.abortDrawing();
      }
      for (var i = 0; i < measureOverlayArrays.length; i++) {
        map.removeOverlay(measureOverlayArrays[i]);
      }
      measureOverlayArrays = [];
      measurevector.getSource().clear();
    });

    //Show X,Y coordinates
    map.on('pointermove', function (e) {
      var x = ol.proj.toLonLat(e.coordinate)[0];
      $("#x")[0].innerHTML = x.toFixed(4);
      var y = ol.proj.toLonLat(e.coordinate)[1];
      $("#y")[0].innerHTML = y.toFixed(4);
    });

    $('input[type="radio"]').click(function () {
      if ($(this).prop("checked")) {
        var layername = $(this).val()
      }
      if (layername == 'otm') {
        $("#esa-legend").css("display", "none");
        worldcover.setVisible(false);
        sentinellayer.setVisible(false);
        osmlayer.setVisible(false);
        streetMaplayer.setVisible(false);
        otmlayer.setVisible(true);
      } else if (layername == 'streetMap') {
        $("#esa-legend").css("display", "none");
        worldcover.setVisible(false);
        sentinellayer.setVisible(false);
        osmlayer.setVisible(false);
        streetMaplayer.setVisible(true);
        otmlayer.setVisible(false);
      } else if (layername == 'osm') {
        $("#esa-legend").css("display", "none");
        worldcover.setVisible(false);
        sentinellayer.setVisible(false);
        osmlayer.setVisible(true);
        streetMaplayer.setVisible(false);
        otmlayer.setVisible(false);
      } else if (layername == 'sen2') {
        $("#esa-legend").css("display", "none");
        worldcover.setVisible(false);
        sentinellayer.setVisible(true);
        osmlayer.setVisible(false);
        streetMaplayer.setVisible(false);
        otmlayer.setVisible(false);
      } else if (layername == 'esa') {
        $("#esa-legend").css("display", "block");
        worldcover.setVisible(true);
        sentinellayer.setVisible(false);
        streetMaplayer.setVisible(false);
        osmlayer.setVisible(false);
        otmlayer.setVisible(false);
      }
    })

    $('input[type="checkbox"]').click(function () {
      if ($(this).prop("checked")) {
        var layername = $(this).val()
      }
      if (layername == 'myareas') {
        areavector.setVisible(true);
        basinvector.setVisible(false);
        boundsvector.setVisible(false);
        $('#checkbasins').prop("checked", false);
        $('#checkDistricts').prop("checked", false);
      } else {
        areavector.setVisible(false);
      }
      if (layername == 'basins') {
        basinvector.setVisible(true);
        areavector.setVisible(false);
        boundsvector.setVisible(false);
        $('#checkDistricts').prop("checked", false);
        $('#checkareas').prop("checked", false);
      } else {
        basinvector.setVisible(false);
      }
      if (layername == 'boundaries') {
        boundsvector.setVisible(true);
        basinvector.setVisible(false);
        areavector.setVisible(false);
        $('#checkbasins').prop("checked", false);
        $('#checkareas').prop("checked", false);
      } else {
        boundsvector.setVisible(false);
      }
    })
    //var modify = new ol.interaction.Modify({source: polysource});
    //map.addInteraction(modify);

    var draw, snap; // global so we can remove them later
    var typeSelect = document.getElementById('type');

    function addInteractions() {
      polysource.clear()
      $('#areaSelect').val('noarea')
      draw = new ol.interaction.Draw({
        source: polysource,
        type: 'Polygon',
      });
      draw.on('drawstart', function (event) {
        event.feature.getGeometry().on('change', function (e) {
          window.event = event;
        });
      });
      draw.on('drawend', function (event) {
        var feat = event.feature;
        areafeat = feat.clone()
        areafeat.getGeometry().transform(epsgsrc, epsgmoll);
        if (feat.getGeometry().getArea() < 50000000) {
          $("#returnText").text("The area is too small, please draw a bigger area");
          $("#returnModal").modal('show');
          polysource.clear();
          //} else if (feat.getGeometry().getArea() > 100000000) {
          //            	$("#returnText").text("The area is to big, please draw a bigger area");
          //              $("#returnModal").modal('show');
          //              polysource.clear();
        } else {
          feat.getGeometry().transform(epsgsrc, espgdest)
          var geoJsonStr = geoJSONFormat.writeGeometry(feat.getGeometry());
          $("#featGeom").val(geoJsonStr);
          drawModal.show()
        }

      });
      map.addInteraction(draw);
      snap = new ol.interaction.Snap({ source: polysource });
      map.addInteraction(snap);
    }

    $('#addarea').click(function () {
      if ($(this).hasClass('active')) {
        addInteractions();
      } else {
        map.removeInteraction(draw);
        map.removeInteraction(snap);
      }
    })
    $('#addlayerbtn').click(function () {
      if ($(this).hasClass('active')) {
        map.removeInteraction(draw);
        map.removeInteraction(snap);
      }
    })


    function checkDataConstraint() {
      var element = $("#areaSelect").find(':selected')
      if (element.data('geom') === undefined) {
        $("#getReport").prop("disabled", true);
        return
      }
      var jsongeom = element.data('geom')
      var multipolys = new ol.geom.MultiPolygon(jsongeom['coordinates']).getPolygons()
      //var olgeom = geoJSONFormat.writeGeometryObject(new ol.geom.MultiPolygon(jsongeom['coordinates']))
      //console.log(olgeom)
      for (let poly in multipolys) {
        var geom = geoJSONFormat.writeGeometryObject(multipolys[poly])
        var maincheck = turf.booleanContains(mainBondingBox['geometry'], geom)
        if (maincheck == false) {
          $("#returnText").text("");
          $("#returnText").text("The selected area exceed from general bounding box (-180,-70,180,70) ")
          $("#returnModal").modal('show');
          $("#getReport").prop("disabled", true);
          return
        }
      }

      var precip = $('#precip').val();
      if (precip == "chirps") {
        var precipBoundingBox = turf.polygon([[[-180, -50], [-180, 50], [180, 50], [180, -50], [-180, -50]]], { name: 'precip bounding box' })
        for (let poly in multipolys) {
          var geom = geoJSONFormat.writeGeometryObject(multipolys[poly])
          var precipcheck = turf.booleanContains(precipBoundingBox['geometry'], geom)
          if (precipcheck == false) {
            $("#returnText").text("");
            $("#returnText").text("The selected area exceed from CHIRPS bounding box (-180, -50, 180, 50) ")
            $("#returnModal").modal('show');
            $("#getReport").prop("disabled", true);
            return
          }
        }
      } else if (precip == "persiann") {
        var precipBoundingBox = turf.polygon([[[-180, -60], [-180, 60], [180, 60], [180, -60], [-180, -60]]], { name: 'precip bounding box' })
        for (let poly in multipolys) {
          var geom = geoJSONFormat.writeGeometryObject(multipolys[poly])
          var precipcheck = turf.booleanContains(precipBoundingBox['geometry'], geom)
          if (precipcheck == false) {
            $("#returnText").text("");
            $("#returnText").text("The selected area exceed from PERSIANN bounding box (-180, -60, 180, 60) ")
            $("#returnModal").modal('show');
            $("#getReport").prop("disabled", true);
            return
          }
        }
      } else if (precip == "enspcp") {
        var precipBoundingBox = turf.polygon([[[-180, -50], [-180, 50], [180, 50], [180, -50], [-180, -50]]], { name: 'precip bounding box' })
        for (let poly in multipolys) {
          var geom = geoJSONFormat.writeGeometryObject(multipolys[poly])
          var precipcheck = turf.booleanContains(precipBoundingBox['geometry'], geom)
          if (precipcheck == false) {
            $("#returnText").text("");
            $("#returnText").text("The selected area exceed from Ensemble bounding box (-180, -60, 180, 60) ")
            $("#returnModal").modal('show');
            $("#getReport").prop("disabled", true);
            return
          }
        }
      }

      var et = $('#et').val();
      if (et == "wapor2") {
        for (let poly in multipolys) {
          var geom = geoJSONFormat.writeGeometryObject(multipolys[poly])
          for (let wapor in wapor_source) {
            var waporcheck = turf.booleanContains(wapor_source[wapor], geom)
            if (waporcheck == false) {
              $("#returnText").text("");
              $("#returnText").text("The selected area exceed from WaPOR bounding box (cover only Africa) ")
              $("#returnModal").modal('show');
              $("#getReport").prop("disabled", true);
              $("#et").val("ssebop");
              return
            }
          }
        }
      } else if (et == "enset") {
        for (let poly in multipolys) {
          var geom = geoJSONFormat.writeGeometryObject(multipolys[poly])
          for (let enset in wapor_source) {
            var waporcheck = turf.booleanContains(wapor_source[enset], geom)
            if (waporcheck == false) {
              $("#returnText").text("");
              $("#returnText").text("The selected area exceed from Ensemble bounding box (cover only Africa) ")
              $("#returnModal").modal('show');
              $("#getReport").prop("disabled", true);
              $("#et").val("ssebop");
              return
            }
          }
        }
      }
      $("#getReport").prop("disabled", false);
    }

    function addBB() {
      var geom = newfeat.getGeometry()
      var newgeom = geom.transform(epsgsrc, espgdest)
      var geoJsonStr = geoJSONFormat.writeGeometry(newgeom);
      $("#featGeom").val(geoJsonStr);
      $("#featName").val(newfeat.get('name'));
      var newgeom = geom.transform(espgdest, epsgsrc)
      addFeatures()
    }


    function isFeatureAdded(featureName) {
      var isAdded = false;
      $('#areaSelect option').each(function () {
        if ($(this).text() === featureName) {
          isAdded = true;
          return false; // Break the loop
        }
      });
      return isAdded;
    }


    map.on('click', function (e) {
      var coordinate = e.coordinate;
      map.forEachFeatureAtPixel(e.pixel, function (f, l) {

        polysource.clear()
        bobasource.clear()
        if (newfeat !== null) {
          var oldid = newfeat.get('id')
          newfeat.setStyle(undefined);
          newfeat = null
        }
        newfeat = f


        if (l.get('name') == 'areas') {
          $('#areaSelect').val(f.get('id'))
          $('#areaSelect').change();

        } else {
          var featureName;
          if (l.get('name') == 'basins') {
            featureName = f.get('Watersheds');
          } else if (l.get('name') == 'bounds') {
            featureName = f.get('District');
          } else if (l.get('name') == 'selected,') {
            featureName = f.get('name');
          }

          var contenttext = '<h5>' + featureName + '</h5>';
          contenttext = contenttext + '<div class="row">'
          {% if user.is_authenticated %}
          if (!isFeatureAdded(featureName)) {
            contenttext = contenttext + '<div class="col-6"><button type="button" class="btn btn-primary m-1"  data-bs-toggle="button" autocomplete="off" title="Add feature to own areas" id="basinbound" onclick="addBB()">Add</button></div>';
          } else {
            contenttext = contenttext + '<p style="color: red;"">Added to your areas</p>';
          }
          {% endif %}
          contenttext = contenttext + '</div>'
          content.innerHTML = contenttext;

          var ext = newfeat.getGeometry().getExtent();
          bobasource.addFeature(newfeat);
          var center = ol.extent.getCenter(ext);
          map.getView().fit(ext, map.getSize());
          overlay.setPosition(coordinate);
        }
      })
    })




    function getReport() {
      var area = $('#areaSelect').val();
      console.log('area', area)
      var start = $('#startdate').val();
      var end = $('#enddate').val();
      var precip = $('#precip').val();
      var et = $('#et').val();


      if (area == 'noarea') {
        $("#returnText").text("");
        $("#returnText").text("Please select an area to get the report")
        $("#returnModal").modal('show');
        return
      }

      $('.main_preloader').css('display', 'flex');

      $.ajax({
        type: "POST",
        url: "/getreport",
        data: { id: area, start: start, end: end, precip: precip, et: et }
      }).done(function (msg) {
        $("#returnText").text("");
        $("#returnText").text(msg['result'] +
          "You will receive an email with link to the report within 5 - 10 minutes, once it is ready.")
        $('.main_preloader').css('display', 'none');
        $("#returnModal").modal('show');
        sleep(6000);
        getTasks();
      }).fail(function (msg) {
        $("#returnText").text("");
        $("#returnText").text(msg['result'])
        $('.main_preloader').css('display', 'none');
        $("#returnModal").modal('show');
      })
    }

    $('#et').change(function () {
      checkDataConstraint();
    })

    $('#precip').change(function () {
      checkDataConstraint();
    })

    $('#areaSelect').change(function () {
      polysource.clear()
      var element = $(this).find(':selected')
      if (element.data('geom') === undefined) {
        return
      }
      var geom = element.data('geom')
      var myname = element.text()
      var myid = element.val()
      newfeat = new ol.Feature({ geometry: new ol.geom.MultiPolygon(geom['coordinates']).transform(espgdest, epsgsrc), name: myname, myid })
      newfeat.setId(myid)
      var ext = newfeat.getGeometry().getExtent();
      polysource.addFeature(newfeat);
      var center = ol.extent.getCenter(ext);
      map.getView().fit(ext, map.getSize());
      $('#selectWatershed').val('noarea');
      $('#selectDistrict').val('noarea');
      checkDataConstraint();
    })

    function readFile(input) {
      file = input.files[0];
    }

    function addLayer() {
      var reader = new FileReader();
      reader.readAsText(file, 'UTF-8');
      reader.onload = shipOff;

      function shipOff(event) {
        var result = event.target.result;
        $.ajax({
          type: "POST",
          url: "/addlayer",
          data: { namecol: $("#customName").val(), file: result }
        }).done(function (msg) {
          $("#addLayer").modal('hide');
          $("#returnText").text("")
          $("#returnText").text(msg['result']);
          $("#returnModal").modal('show');
          getAreas();
        }).fail(function (msg) {
          $("#addLayer").modal('hide');
          $("#returnText").text("");
          $("#returnText").text(msg.responseJSON['result']);
          $("#returnModal").modal('show');
          getAreas();
        });
      }
    }
function addyear() {
  var precip = $('#precip').val();
  var et = $('#et').val();

  var startYear;
  var endYear;
  var selectedStartYear;

  if (et === 'wapor3' || et === 'ensetglobal') {
    startYear = 2018;
    endYear = 2023;
    selectedStartYear = 2018;
  } else if (et === 'nrsc') {
    startYear = 2016;
    endYear = 2023;
    selectedStartYear = 2016;
  } else {
    startYear = 2009;
    endYear = 2023;
    selectedStartYear = 2010;
  }

  $('#startdate').empty();
  $('#enddate').empty();

  for (var i = startYear; i <= endYear; i++) {
    if (i === selectedStartYear) {
      $('#startdate').append('<option value="' + i + '" selected>' + i + '</option>');
    } else {
      $('#startdate').append('<option value="' + i + '">' + i + '</option>');
    }

    if (i === endYear) {
      $('#enddate').append('<option value="' + i + '" selected>' + i + '</option>');
    } else {
      $('#enddate').append('<option value="' + i + '">' + i + '</option>');
    }
  }
}


    window.addEventListener('resize', checkSize);

    $(document).ready(function () {
      osmlayer.setVisible(false);
      otmlayer.setVisible(true);
      window.addFeatures = function () {
        $.ajax({
          type: "POST",
          url: "/addfeature",
          data: { name: $("#featName").val(), geom: $("#featGeom").val() }
        }).done(function (msg) {
          $("#drawModal").modal('hide');
          $("#returnText").text("");
          $("#returnText").text(msg['result'])
          $("#returnModal").modal('show');
          addid = msg['featid'];
          getAreas(addid);
        }).fail(function (msg) {
          $("#drawModal").modal('hide');
          $("#returnText").text("");
          $("#returnText").text(msg.responseJSON['result']);
          $("#returnModal").modal('show');
          getAreas();
        });
      }

      window.getAreas = function (myid) {
        $.ajax({
          type: "GET",
          url: "/getareas"
        }).done(function (msg) {
          // console.log(msg)
          $('#areaSelect').find('option').remove().end().append('<option value="noarea" id="noarea">Select an area</option>').val('noarea')
          areasource.clear()
          for (i = 0; i < msg['features'].length; i++) {
            if (msg['features'][i]['id'] == myid) {
              $('#areaSelect').append("<option selected value=" +
                msg['features'][i]['id'] + " data-geom='" + JSON.stringify(msg['features'][i]['geometry']) + "' class='areatoselect'>" +
                msg['features'][i]['properties']['name'] + "</option>");
            } else {
              $('#areaSelect').append("<option value=" +
                msg['features'][i]['id'] + " data-geom='" + JSON.stringify(msg['features'][i]['geometry']) + "' class='areatoselect'>" +
                msg['features'][i]['properties']['name'] + "</option>");
            }
            var geom = new ol.geom.MultiPolygon(msg['features'][i]['geometry']['coordinates']).transform(espgdest, epsgsrc)
            newfeat = new ol.Feature({ geometry: geom, name: msg['features'][i]['properties']['name'], id: msg['features'][i]['id'] })
            newfeat.setId(msg['features'][i]['id'])
            areasource.addFeature(newfeat);
          }
          $('#areaSelect').change();
        })
      }




      // Script to pass taskid to the modal
      $('#deleteReport-modal').on('show.bs.modal', function (event) {
        var button = $(event.relatedTarget) // Button that triggered the modal
        var taskid = button.data('taskid') // Extract info from data-* attributes
        var modal = $(this)
        modal.find('#confirmDeleteBtn').data('taskid', taskid) // Set taskid to the confirm button for later use
      });

      // Script to handle the actual deletion
      $('#confirmDeleteBtn').click(function () {
        var taskid = $(this).data('taskid');
        deleteTaskHistory(taskid); // Call your function to delete the task
      });

      function deleteTaskHistory(taskid) {
        $.ajax({
          type: "GET",
          url: "/deletetaskhistory/" + taskid
        }).done(function (msg) {
          getTasks(); // Refresh the task list after deletion
          $("#returnText").text(""); // Clear any previous message
          $("#returnText").text(msg['result']); // Set the success message from server
          $("#returnModal").modal('show'); // Show the modal with the result
          $('#deleteReport-modal').modal('hide'); // Hide the delete confirmation modal
        }).fail(function (msg) {
          $("#returnText").text(""); // Clear any previous message
          $("#returnText").text(msg['result']); // Set the error message from server
          $("#returnModal").modal('show'); // Show the modal with the error
        });
      }



      window.getTasks = function () {
        $.ajax({
          type: "GET",
          url: "/gettasks"
        }).done(function (msg) {
          $("#previoustasks").text("");
          var tasks = '<h5 class="card-title text-center"></h5>'
          for (i = 0; i < msg['data'].length; i++) {
            tasks += '<div>' + msg['data'][i]['fields']['area'] + "<br>" + msg['data'][i]['fields']['data'].replace('T', ' ').split('.', 1) + "<br>" +
              '<a href="/media/' + msg['data'][i]['fields']['task'] + '/index.html" target="_blank" class="btn btn-primary m-1">View</a>' +
              '<a href="/media/' + msg['data'][i]['fields']['task'] + '/report.pdf" target="_blank" class="btn btn-primary m-1">PDF</a>' +
              // '<a onclick="deleteTaskhistory(' + msg['data'][i]['id'] + ')" class="btn btn-danger me-1">Delete</a></div> <hr>'
              '<a data-bs-toggle="modal" data-bs-target="#deleteReport-modal" data-taskid="' + msg['data'][i]['id'] + '" class="btn btn-danger me-1">Delete</a></div> <hr>'

            // if (i != msg['data'].length - 1) {
            //   tasks += '<hr>';
            // }
          }
          $("#previoustasks").append(tasks);
        })
      }


      checkSize();
      getAreas();
      addyear();
      $('#et').change(function () {
        addyear();
      });

      $('#precip').change(function () {
        addyear();
      });
      getTasks();
      $.getJSON('/static/data/wapor_bound.geojson', function (data) {
        features = data.features;
        for (var i = 0, len = features.length; i < len; i++) {
          wapor_source.push(features[i]);
        }
      })
    })





  </script>
</body>

</html>